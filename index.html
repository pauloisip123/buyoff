<!DOCTYPE html>
<html lang="fil">
<head>
    <meta charset="UTF-8">
    <title>VTS Dashboard - CS Search Update</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        
        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; flex-direction: column; }
        .login-box { background: white; padding: 25px; border-radius: 5px; text-align: center; color: #333; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; box-sizing: border-box; }

        /* HEADER & UPLOAD */
        .upload-section { background: white; padding: 15px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-bottom: 10px; display: flex; align-items: center; gap: 20px; }
        .upload-group { font-size: 13px; font-weight: bold; }
        button { border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .btn-refresh { background: #28a745; color: white; }
        .btn-display { background: #4472c4; color: white; }

        /* BLUE TITLE BAR */
        .vts-title-bar { background-color: #4472c4; color: white; padding: 8px 15px; font-weight: bold; font-size: 14px; border: 1px solid #2f5597; }

        /* DASHBOARD TABLE */
        .table-container { overflow-x: auto; background: white; border: 1px solid #000; margin-bottom: 15px; }
        .main-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .main-table th, .main-table td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; }
        .cat-status-header { background-color: #333; color: white; width: 250px; }
        .loc-header { background-color: #ffff00; color: #000; font-weight: bold; }
        .total-header { background-color: #ffc000; color: #000; font-weight: bold; }
        .stat-sub { display: block; font-size: 9px; font-weight: normal; }
        .var-row { background-color: #fce4d6; color: #ff0000; font-weight: bold; }
        .clickable { cursor: pointer; text-decoration: underline; }

        /* DETAILS TABLE */
        .details-container { overflow-y: auto; max-height: 500px; border: 1px solid #000; background: white; }
        .details-table { width: 100%; border-collapse: collapse; }
        .details-table thead th { position: sticky; top: 0; background-color: #333; color: white; padding: 10px 4px; border: 1px solid #000; font-size: 11px; z-index: 10; }
        
        /* FILTERS */
        .cs-search-input { width: 90%; padding: 4px; font-size: 10px; border: 1px solid #ccc; margin-top: 5px; outline: none; }
        .filter-box { background: white; color: black; border: 1px solid #ccc; padding: 2px; width: 95%; cursor: pointer; font-size: 10px; margin-top: 5px; text-align: left; display: inline-block; position: relative; }
        .dropdown-menu { display: none; position: absolute; background: white; border: 1px solid #333; width: 200px; max-height: 250px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.2); padding: 5px; color: black; font-weight: normal; }
        .dropdown-menu label { display: block; padding: 4px; cursor: pointer; border-bottom: 1px solid #eee; }
        .show { display: block; }

        .details-table td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 11px; white-space: nowrap; }
        .na-text { color: red; font-weight: bold; }
        .tally-green { color: green; font-weight: bold; }
        .tally-red { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h3>VTS Dashboard Login</h3>
            <input type="password" id="passInput" placeholder="Password" onkeypress="if(event.key==='Enter')login()">
            <button class="btn-display" onclick="login()" style="width:100%">LOGIN</button>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="upload-section">
            <div class="upload-group">1. HAULING PLAN:<br><input type="file" id="hInput" accept=".xlsx"></div>
            <div class="upload-group">2. ANDON (Multiple):<br><input type="file" id="aInput" accept=".csv" multiple></div>
            <button class="btn-refresh" onclick="processData()">REFRESH</button>
            <button class="btn-display" onclick="showDetails()">SHOW DETAILS</button>
        </div>

        <div class="vts-title-bar">VTS MONITORING DASHBOARD</div>
        <div class="table-container">
            <table class="main-table">
                <thead>
                    <tr>
                        <th colspan="2" class="cat-status-header">CATEGORY / STATUS</th>
                        <th class="loc-header">1K11 - Aratan <span id="s-1K11" class="stat-sub"></span></th>
                        <th class="loc-header">1K06 - Crosstown <span id="s-1K06" class="stat-sub"></span></th>
                        <th class="loc-header">1K07 - FilSyn <span id="s-1K07" class="stat-sub"></span></th>
                        <th class="loc-header">1K03 - LGICT <span id="s-1K03" class="stat-sub"></span></th>
                        <th class="loc-header">1K12 - Lawa <span id="s-1K12" class="stat-sub"></span></th>
                        <th class="total-header">TOTAL <span id="s-TOTAL" class="stat-sub"></span></th>
                    </tr>
                </thead>
                <tbody id="dashBody"></tbody>
            </table>
        </div>

        <div id="detailsArea" style="display:none;">
            <div class="vts-title-bar" style="display:flex; justify-content:space-between;">
                <span>HAULING PLAN DETAILS</span>
                <span id="rowStats"></span>
            </div>
            <div class="details-container">
                <table class="details-table" id="detailsTable">
                    <thead id="detailsHead"></thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function login() { if(document.getElementById('passInput').value === "Ems@pau123") { document.getElementById('loginOverlay').style.display='none'; document.getElementById('mainApp').style.display='block'; } }

        let haulingData = [], andonData = [];
        const cols = ["C/S No.", "Model Description", "Exterior Color", "Vehicle Stockyard", "ETD MP", "DESTINATION", "ETA DEALER / POL", "CARRIER", "PREPARED (AC)", "INSPECTED (AD)"];

        document.getElementById('hInput').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array', cellDates:true});
                haulingData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {raw:false});
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        document.getElementById('aInput').addEventListener('change', async e => {
            andonData = [];
            for (let f of e.target.files) {
                const d = await new Promise(res => Papa.parse(f, {header:true, skipEmptyLines:true, complete: r => res(r.data)}));
                andonData = [...andonData, ...d];
            }
        });

        function processData() {
            if(!haulingData.length) return alert("Upload Hauling Plan.");
            const aMap = new Map();
            andonData.forEach(r => { if(r.csnumber) aMap.set(r.csnumber.trim().toUpperCase(), r); });
            const locs = ["1K11", "1K06", "1K07", "1K03", "1K12"];
            locs.forEach(l => {
                const p = haulingData.filter(u => String(u['Vehicle Stockyard']).includes(l)).length;
                const a = haulingData.filter(u => String(u['Vehicle Stockyard']).includes(l) && aMap.has(String(u['C/S No.']).trim().toUpperCase())).length;
                const el = document.getElementById(`s-${l}`);
                el.innerText = `(${a}/${p})`; el.className = `stat-sub ${a===p && p>0 ? 'tally-green':'tally-red'}`;
            });
            const cats = ["RVL", "DSTC", "RPM", "WILL EX", "GSDC"];
            let h = "";
            cats.forEach(c => {
                let p=[], pr=[], insp=[], vr=[];
                locs.forEach(l => {
                    const u = haulingData.filter(x => String(x['CARRIER']).toUpperCase().includes(c) && String(x['Vehicle Stockyard']).includes(l));
                    p.push(u.length);
                    let ctPr=0, ctIn=0;
                    u.forEach(unit => {
                        const m = aMap.get(String(unit['C/S No.']).trim().toUpperCase());
                        if(m){ if(m.prepared==='Y') ctPr++; if(m.inspected_by && m.inspected_by!=='NULL') ctIn++; }
                    });
                    pr.push(ctPr); insp.push(ctIn); vr.push(u.length - ctIn);
                });
                const sum = arr => arr.reduce((a,b)=>a+b,0);
                h += `<tr><td rowspan="4">${c}</td><td>PLAN</td>${p.map((x,i)=>`<td class="${x>0?'clickable':''}" onclick="filterDashboard('PLAN','${c}','${locs[i]}',${x})">${x}</td>`).join('')}<td>${sum(p)}</td></tr>`;
                h += `<tr style="background:#e2efda"><td>PREP</td>${pr.map((x,i)=>`<td class="${x>0?'clickable':''}" onclick="filterDashboard('PREP','${c}','${locs[i]}',${x})">${x}</td>`).join('')}<td>${sum(pr)}</td></tr>`;
                h += `<tr style="background:#fff2cc"><td>INSP</td>${insp.map((x,i)=>`<td class="${x>0?'clickable':''}" onclick="filterDashboard('INSP','${c}','${locs[i]}',${x})">${x}</td>`).join('')}<td>${sum(insp)}</td></tr>`;
                h += `<tr class="var-row"><td>VAR</td>${vr.map((x,i)=>`<td class="${x>0?'clickable':''}" onclick="filterDashboard('VAR','${c}','${locs[i]}',${x})">${x}</td>`).join('')}<td>${sum(vr)}</td></tr>`;
            });
            document.getElementById('dashBody').innerHTML = h;
        }

        function showDetails() {
            const aMap = new Map();
            andonData.forEach(r => { if(r.csnumber) aMap.set(r.csnumber.trim().toUpperCase(), r); });
            const merged = haulingData.map(r => {
                const cs = String(r['C/S No.']||"").trim().toUpperCase();
                const m = aMap.get(cs);
                return { ...r, "PREPARED (AC)": m ? (m.prepared || "N") : "n/a", "INSPECTED (AD)": m ? (m.inspected_by || "") : "" };
            });

            let head = "<tr>";
            cols.forEach((col, i) => {
                if(col === "C/S No.") {
                    head += `<th>${col}<br><input type="text" id="csSearchBox" class="cs-search-input" placeholder="Type C/S No..." onkeyup="applyFilters()"></th>`;
                } else {
                    const unique = [...new Set(merged.map(x => String(x[col]||"").trim()))].sort();
                    head += `<th>${col}<br><div class="filter-box" onclick="toggleDrop(${i})">Filter â–¼<div id="d-${i}" class="dropdown-menu" onclick="event.stopPropagation()">
                        <input type="text" placeholder="Search..." onkeyup="searchFilter(${i}, this)" style="width:100%; box-sizing:border-box; margin-bottom:5px;">
                        <label><input type="checkbox" checked onchange="checkAll(${i}, this)"> (All)</label>
                        ${unique.map(v => `<label><input type="checkbox" value="${v||'BLANK'}" checked onchange="applyFilters()"> ${v||'(Blanks)'}</label>`).join('')}
                    </div></div></th>`;
                }
            });
            document.getElementById('detailsHead').innerHTML = head + "</tr>";
            document.getElementById('detailsBody').innerHTML = merged.map(r => `<tr>${cols.map(c => `<td class="${r[c]==='n/a'?'na-text':''}">${r[c]||""}</td>`).join('')}</tr>`).join('');
            document.getElementById('detailsArea').style.display = 'block';
            updateRowStats();
        }

        function toggleDrop(i) {
            const d = document.getElementById(`d-${i}`);
            if(!d) return;
            const isShow = d.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if(!isShow) d.classList.add('show');
        }

        function checkAll(i, m) { document.getElementById(`d-${i}`).querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = m.checked); applyFilters(); }
        
        function searchFilter(i, input) {
            const val = input.value.toUpperCase();
            document.getElementById(`d-${i}`).querySelectorAll('label').forEach(l => {
                if(l.innerText !== "(All)") l.style.display = l.innerText.toUpperCase().includes(val) ? "" : "none";
            });
        }

        function applyFilters() {
            const rows = document.getElementById('detailsBody').rows;
            const csSearchVal = document.getElementById('csSearchBox')?.value.toUpperCase() || "";
            
            const dropdownFilters = {};
            cols.forEach((_, i) => {
                const d = document.getElementById(`d-${i}`);
                if(d) dropdownFilters[i] = Array.from(d.querySelectorAll('input:checked')).map(c => c.value);
            });

            let count = 0;
            for (let r of rows) {
                let show = true;
                // Check C/S No. Search Box
                if(csSearchVal && !r.cells[0].innerText.toUpperCase().includes(csSearchVal)) show = false;
                
                // Check Dropdown Filters
                if(show) {
                    for (let i in dropdownFilters) {
                        const cellVal = r.cells[i].innerText.trim() || "BLANK";
                        if(!dropdownFilters[i].includes(cellVal)) { show = false; break; }
                    }
                }
                r.style.display = show ? "" : "none";
                if(show) count++;
            }
            document.getElementById('rowStats').innerText = `${count} / ${rows.length}`;
        }

        function filterDashboard(type, cat, loc, val) {
            if(val === 0) return;
            showDetails();
            const rows = document.getElementById('detailsBody').rows;
            let visibleCount = 0;
            for (let r of rows) {
                const isCat = r.cells[7].innerText.toUpperCase().includes(cat);
                const isLoc = r.cells[3].innerText.includes(loc);
                let match = isCat && isLoc;
                if(match) {
                    if(type === 'PREP') match = r.cells[8].innerText === 'Y';
                    if(type === 'INSP') match = r.cells[9].innerText !== "" && r.cells[9].innerText !== "NULL" && r.cells[9].innerText !== "n/a";
                    if(type === 'VAR') match = r.cells[9].innerText === "" || r.cells[9].innerText === "NULL" || r.cells[9].innerText === "n/a";
                }
                r.style.display = match ? "" : "none";
                if(match) visibleCount++;
            }
            document.getElementById('rowStats').innerText = `${visibleCount} / ${rows.length}`;
        }

        function updateRowStats() { document.getElementById('rowStats').innerText = `${document.getElementById('detailsBody').rows.length} / ${document.getElementById('detailsBody').rows.length}`; }

        window.onclick = e => { if(!e.target.matches('.filter-box')) document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')); }
    </script>
</body>
</html>
